name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

# Grant necessary permissions for creating releases
permissions:
  contents: write
  packages: write

env:
  REGISTRY: docker.io
  IMAGE_NAME: get_invoice_done

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Generate changelog
      id: changelog
      run: |
        # Generate changelog from git commits
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        else
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        fi
        
        if [ -n "$PREVIOUS_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
        else
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
        fi
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Release
      id: create_release
      run: |
        # Create release body
        cat > release_body.md << 'EOF'
        ## ğŸš€ å‘ç¥¨OCRç³»ç»Ÿ ${{ steps.get_version.outputs.version }}

        ### ğŸ“‹ æ›´æ–°å†…å®¹
        ${{ steps.changelog.outputs.changelog }}

        ### ğŸ³ Dockeré•œåƒ
        ```bash
        docker pull kis2show/${{ env.IMAGE_NAME }}:${{ steps.get_version.outputs.version }}
        ```

        ### ğŸš€ å¿«é€Ÿéƒ¨ç½²
        ```bash
        # ä¸‹è½½é…ç½®æ–‡ä»¶
        wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/docker-compose.yml
        wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/.env.production

        # é…ç½®ç¯å¢ƒå˜é‡
        cp .env.production .env
        # ç¼–è¾‘ .env æ–‡ä»¶ï¼Œæ›´æ–° SECRET_KEY å’Œ CORS_ORIGINS

        # å¯åŠ¨æœåŠ¡
        docker-compose up -d
        ```

        ### ğŸ“Š ç³»ç»Ÿè¦æ±‚
        - CPU: 2æ ¸å¿ƒä»¥ä¸Š
        - å†…å­˜: 4GBä»¥ä¸Š
        - å­˜å‚¨: 10GBä»¥ä¸Š
        - Docker: 20.10.0+
        - Docker Compose: 1.29.0+

        ### ğŸ”’ å®‰å…¨æé†’
        - è¯·æ›´æ–° `.env` æ–‡ä»¶ä¸­çš„ `SECRET_KEY`
        - é…ç½®æ­£ç¡®çš„ `CORS_ORIGINS` åŸŸå
        - å»ºè®®å¯ç”¨HTTPSå’Œé˜²ç«å¢™
        EOF

        # Create release using GitHub CLI
        gh release create ${{ steps.get_version.outputs.version }} \
          --title "Release ${{ steps.get_version.outputs.version }}" \
          --notes-file release_body.md \
          --target ${{ github.sha }}

        # Get upload URL for compatibility
        upload_url=$(gh api repos/${{ github.repository }}/releases/tags/${{ steps.get_version.outputs.version }} --jq '.upload_url')
        echo "upload_url=$upload_url" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-release:
    name: Build Release Assets
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Build and push release image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY }}/kis2show/${{ env.IMAGE_NAME }}:${{ needs.create-release.outputs.version }}
          ${{ env.REGISTRY }}/kis2show/${{ env.IMAGE_NAME }}:latest
        labels: |
          org.opencontainers.image.title=${{ env.IMAGE_NAME }}
          org.opencontainers.image.description=Invoice OCR System
          org.opencontainers.image.version=${{ needs.create-release.outputs.version }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.source=${{ github.repositoryUrl }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Create deployment package
      run: |
        mkdir -p release-package
        
        # Copy deployment files
        cp docker-compose.yml release-package/
        cp .env.production release-package/
        cp deploy.sh release-package/
        cp deploy.bat release-package/
        cp PRODUCTION_CHECKLIST.md release-package/
        cp PRODUCTION_READY_SUMMARY.md release-package/
        cp README.md release-package/
        
        # Create deployment script
        cat > release-package/quick-deploy.sh << 'EOF'
        #!/bin/bash
        echo "ğŸš€ å‘ç¥¨OCRç³»ç»Ÿå¿«é€Ÿéƒ¨ç½²è„šæœ¬"
        echo "================================"
        
        # æ£€æŸ¥Docker
        if ! command -v docker &> /dev/null; then
            echo "âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker"
            exit 1
        fi
        
        if ! command -v docker-compose &> /dev/null; then
            echo "âŒ Docker Composeæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker Compose"
            exit 1
        fi
        
        # é…ç½®ç¯å¢ƒå˜é‡
        if [ ! -f .env ]; then
            cp .env.production .env
            echo "âš ï¸ è¯·ç¼–è¾‘ .env æ–‡ä»¶ï¼Œæ›´æ–° SECRET_KEY å’Œ CORS_ORIGINS"
            echo "æŒ‰ä»»æ„é”®ç»§ç»­..."
            read -n 1
        fi
        
        # åˆ›å»ºå¿…è¦ç›®å½•
        mkdir -p data logs invoices/pdf invoices/imge invoices/unrecognized
        
        # å¯åŠ¨æœåŠ¡
        echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
        docker-compose up -d
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 10
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        if curl -f -s http://localhost:8000/health > /dev/null; then
            echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
            echo "ğŸŒ Webç•Œé¢: http://localhost:8000"
            echo "ğŸ” å¥åº·æ£€æŸ¥: http://localhost:8000/health"
        else
            echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            docker-compose logs
        fi
        EOF
        
        chmod +x release-package/quick-deploy.sh
        
        # Create Windows deployment script
        cat > release-package/quick-deploy.bat << 'EOF'
        @echo off
        echo ğŸš€ å‘ç¥¨OCRç³»ç»Ÿå¿«é€Ÿéƒ¨ç½²è„šæœ¬
        echo ================================
        
        REM æ£€æŸ¥Docker
        docker --version >nul 2>&1
        if errorlevel 1 (
            echo âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker Desktop
            pause
            exit /b 1
        )
        
        docker-compose --version >nul 2>&1
        if errorlevel 1 (
            echo âŒ Docker Composeæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker Compose
            pause
            exit /b 1
        )
        
        REM é…ç½®ç¯å¢ƒå˜é‡
        if not exist .env (
            copy .env.production .env
            echo âš ï¸ è¯·ç¼–è¾‘ .env æ–‡ä»¶ï¼Œæ›´æ–° SECRET_KEY å’Œ CORS_ORIGINS
            pause
        )
        
        REM åˆ›å»ºå¿…è¦ç›®å½•
        if not exist data mkdir data
        if not exist logs mkdir logs
        if not exist invoices\pdf mkdir invoices\pdf
        if not exist invoices\imge mkdir invoices\imge
        if not exist invoices\unrecognized mkdir invoices\unrecognized
        
        REM å¯åŠ¨æœåŠ¡
        echo ğŸš€ å¯åŠ¨æœåŠ¡...
        docker-compose up -d
        
        REM ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo â³ ç­‰å¾…æœåŠ¡å¯åŠ¨...
        timeout /t 10 /nobreak >nul
        
        REM æ£€æŸ¥æœåŠ¡çŠ¶æ€
        curl -f -s http://localhost:8000/health >nul 2>&1
        if not errorlevel 1 (
            echo âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼
            echo ğŸŒ Webç•Œé¢: http://localhost:8000
            echo ğŸ” å¥åº·æ£€æŸ¥: http://localhost:8000/health
        ) else (
            echo âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—
            docker-compose logs
        )
        
        pause
        EOF
        
        # Create archive
        tar -czf get_invoice_done-${{ needs.create-release.outputs.version }}.tar.gz -C release-package .
        zip -r get_invoice_done-${{ needs.create-release.outputs.version }}.zip release-package/

    - name: Upload release assets
      run: |
        # Upload all assets using GitHub CLI
        gh release upload ${{ needs.create-release.outputs.version }} \
          get_invoice_done-${{ needs.create-release.outputs.version }}.tar.gz \
          get_invoice_done-${{ needs.create-release.outputs.version }}.zip \
          docker-compose.yml \
          .env.production
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [create-release, build-release]
    
    steps:
    - name: Notify success
      run: |
        echo "ğŸ‰ Release ${{ needs.create-release.outputs.version }} created successfully!"
        echo "ğŸ³ Docker image: kis2show/${{ env.IMAGE_NAME }}:${{ needs.create-release.outputs.version }}"
        echo "ğŸ“¦ Release assets uploaded"
        echo "ğŸš€ Ready for deployment!"
