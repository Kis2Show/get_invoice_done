name: Dependency Update

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools
        
    - name: Update requirements
      run: |
        # Backup current requirements
        cp requirements.txt requirements.txt.backup
        
        # Update dependencies
        pip-compile --upgrade requirements.in || pip-compile --upgrade --generate-hashes requirements.txt
        
    - name: Check for security vulnerabilities
      run: |
        pip install safety
        safety check -r requirements.txt --json > safety-report.json || true
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update dependencies'
        title: 'ğŸ”„ Automated Dependency Update'
        body: |
          ## ğŸ”„ è‡ªåŠ¨ä¾èµ–æ›´æ–°
          
          æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºæ›´æ–°é¡¹ç›®ä¾èµ–åŒ…åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚
          
          ### ğŸ“¦ æ›´æ–°å†…å®¹
          - æ›´æ–°äº† `requirements.txt` ä¸­çš„ä¾èµ–åŒ…ç‰ˆæœ¬
          - è¿è¡Œäº†å®‰å…¨æ¼æ´æ£€æŸ¥
          
          ### ğŸ” æ£€æŸ¥é¡¹ç›®
          - [ ] æŸ¥çœ‹ä¾èµ–åŒ…ç‰ˆæœ¬å˜æ›´
          - [ ] è¿è¡Œæµ‹è¯•ç¡®ä¿å…¼å®¹æ€§
          - [ ] æ£€æŸ¥å®‰å…¨æ¼æ´æŠ¥å‘Š
          - [ ] éªŒè¯åº”ç”¨åŠŸèƒ½æ­£å¸¸
          
          ### ğŸš€ æµ‹è¯•å»ºè®®
          ```bash
          # æœ¬åœ°æµ‹è¯•
          pip install -r requirements.txt
          python -m pytest tests/
          
          # Dockeræµ‹è¯•
          docker-compose build
          docker-compose up -d
          curl http://localhost:8000/health
          ```
          
          ### ğŸ“Š å®‰å…¨æ£€æŸ¥
          å®‰å…¨æ¼æ´æ£€æŸ¥æŠ¥å‘Šå·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹æ˜¯å¦æœ‰éœ€è¦å…³æ³¨çš„å®‰å…¨é—®é¢˜ã€‚
          
          ---
          *æ­¤PRç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
        branch: dependency-update
        delete-branch: true
        
    - name: Upload security report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-report
        path: safety-report.json
